<script>
let editIndex = null;

function el(id) {
  return document.getElementById(id);
}

function addProgram(id) {
  const div = document.createElement("div");
  div.className = "program-row";
  div.innerHTML = `
    <input placeholder="Min" type="number">
    <input placeholder="Max" type="number">
    <button onclick="this.parentNode.remove()">X</button>`;
  el(id).appendChild(div);
}

function addCustom() {
  const div = document.createElement("div");
  div.className = "program-row";
  div.innerHTML = `
    <input placeholder="Field Name">
    <input placeholder="Value">
    <button onclick="this.parentNode.remove()">X</button>`;
  el("customFields").appendChild(div);
}

function collectPrograms(id) {
  return [...el(id).children].map(r => ({
    min: r.children[0].value,
    max: r.children[1].value
  }));
}

function savePolicy() {
  const policy = {
    bankName: el("bankName").value,
    productType: el("productType").value,
    loanType: el("loanType").value,
    loanMin: el("loanMin").value,
    loanMax: el("loanMax").value,
    tenureMin: el("tenureMin").value,
    tenureMax: el("tenureMax").value,
    roiMin: el("roiMin").value,
    roiMax: el("roiMax").value,
    pfMin: el("pfMin").value,
    pfMax: el("pfMax").value,

    appAgeMin: el("appAgeMin").value,
    appAgeMax: el("appAgeMax").value,
    coApplicantMandatory: el("coApplicantMandatory").value,
    coAgeMin: el("coAgeMin").value,
    coAgeMax: el("coAgeMax").value,
    ownHouse: el("ownHouse").value,
    ownHouseGeo: el("ownHouseGeo").value,

    bankingType: el("bankingType").value,
    itrRequired: el("itrRequired").value,
    gstRequired: el("gstRequired").value,
    geoLimit: el("geoLimit").value,

    cibilMin: el("cibilMin").value,
    cibilMax: el("cibilMax").value,
    activeLoansMin: el("activeLoansMin").value,
    activeLoansMax: el("activeLoansMax").value,
    loan6Count: el("loan6Count").value,
    loan6Amount: el("loan6Amount").value,
    loan3Count: el("loan3Count").value,
    loan3Amount: el("loan3Amount").value,
    enq6: el("enq6").value,
    enq3: el("enq3").value,

    abbPrograms: collectPrograms("abbPrograms"),
    itrPrograms: collectPrograms("itrPrograms"),
    gstPrograms: collectPrograms("gstPrograms"),
    incomePrograms: collectPrograms("incomePrograms"),
    custom: [...el("customFields").children].map(r => ({
      field: r.children[0].value,
      value: r.children[1].value
    }))
  };

  let data = JSON.parse(localStorage.getItem("eligiwisePolicies")) || [];

  if (editIndex !== null) {
    data[editIndex] = policy;
    editIndex = null;
  } else {
    data.push(policy);
  }

  localStorage.setItem("eligiwisePolicies", JSON.stringify(data));
  alert("Policy saved successfully");
  loadPolicies();
}

function loadPolicies() {
  const tbody = document.querySelector("#policyTable tbody");
  tbody.innerHTML = "";

  const data = JSON.parse(localStorage.getItem("eligiwisePolicies")) || [];
  data.forEach((p, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.bankName}</td>
      <td>${p.productType}</td>
      <td>${p.loanMin} - ${p.loanMax}</td>
      <td>
        <button onclick="editPolicy(${i})">Edit</button>
        <button class="red" onclick="deletePolicy(${i})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function editPolicy(i) {
  const p = JSON.parse(localStorage.getItem("eligiwisePolicies"))[i];
  editIndex = i;

  for (let key in p) {
    if (el(key)) el(key).value = p[key];
  }

  alert("Edit mode enabled. Update and Save.");
}

function deletePolicy(i) {
  if (!confirm("Delete this policy?")) return;
  let data = JSON.parse(localStorage.getItem("eligiwisePolicies"));
  data.splice(i, 1);
  localStorage.setItem("eligiwisePolicies", JSON.stringify(data));
  loadPolicies();
}

loadPolicies();
</script>
