<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ELIGIWISE -- Eligibility Check</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1100px;
      margin: 20px auto;
      background: #fff;
      padding: 20px 25px 40px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #0a4ea3;
      margin-bottom: 20px;
    }
    h2 {
      background: #0a4ea3;
      color: #fff;
      padding: 8px 10px;
      margin: 25px 0 10px;
      font-size: 16px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      font-size: 14px;
    }
    input, select {
      width: 100%;
      padding: 7px;
      margin-top: 4px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px 20px;
    }
    button {
      margin-top: 18px;
      padding: 10px 18px;
      background: #0a4ea3;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #083b7a;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #0a4ea3;
      color: #fff;
    }
    .eligible {
      color: green;
      font-weight: bold;
    }
    .noteligible {
      color: red;
      font-weight: bold;
    }
    #summary {
      margin-top: 15px;
      font-weight: bold;
    }
    #downloads {
      margin-top: 15px;
      display: none;
    }
  </style>

  <!-- jsPDF + autotable (from CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <!-- SheetJS (for Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
  <div class="container">
    <h1>ELIGIWISE ‚Äì Eligibility Check</h1>

    <!-- SECTION A ‚Äì BASIC PROFILE -->
    <h2>SECTION A ‚Äì BASIC PROFILE</h2>
    <div class="grid">
      <div>
        <label>Business Vintage (Years)</label>
        <input type="number" id="vintage" placeholder="Ex: 3">
      </div>
      <div>
        <label>Turnover (Lakhs)</label>
        <input type="number" id="turnover" placeholder="Ex: 120">
      </div>
      <div>
        <label>Required Loan Amount (Lakhs)</label>
        <input type="number" id="requiredLoan" placeholder="Ex: 25">
      </div>
      <div>
        <label>CIBIL Score</label>
        <input type="number" id="cibil" placeholder="Ex: 720">
      </div>
      <div>
        <label>Own House</label>
        <select id="ownHouse">
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>
    </div>

    <!-- SECTION B ‚Äì BANKING -->
    <h2>SECTION B ‚Äì BANKING</h2>
    <div class="grid">
      <div>
        <label>Banking Type</label>
        <select id="bankingType">
          <option value="All">All Accounts Accepted</option>
          <option value="Current">Current Account</option>
          <option value="Savings">Savings Account</option>
        </select>
      </div>
      <div>
        <label>Average Bank Balance ‚Äì ABB (Lakhs)</label>
        <input type="number" step="0.01" id="abb" placeholder="Ex: 0.75">
      </div>
    </div>

    <!-- SECTION C ‚Äì COMPLIANCE -->
    <h2>SECTION C ‚Äì COMPLIANCE</h2>
    <div class="grid">
      <div>
        <label>GST Available</label>
        <select id="gst">
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>
      <div>
        <label>ITR Available</label>
        <select id="itr">
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
      </div>
    </div>

    <button type="button" onclick="checkEligibility()">üîç Check Eligibility</button>

    <!-- SUMMARY -->
    <div id="summary"></div>

    <!-- RESULT TABLE -->
    <table id="resultTable" style="display:none;">
      <thead>
        <tr>
          <th>Bank / NBFC</th>
          <th>Status</th>
          <th>Max Loan (Lakhs)</th>
          <th>Remarks</th>
        </tr>
      </thead>
      <tbody id="resultBody"></tbody>
    </table>

    <!-- DOWNLOAD BUTTONS -->
    <div id="downloads">
      <button type="button" onclick="downloadExcel()">‚¨á Download Excel</button>
      <button type="button" onclick="downloadPDF()">‚¨á Download PDF</button>
    </div>
  </div>

  <script>
    function getPolicies() {
      try {
        const data = localStorage.getItem("eligiwisePolicies");
        if (!data) return [];
        return JSON.parse(data);
      } catch (e) {
        alert("Error reading bank policies. Please re-save from Admin.");
        return [];
      }
    }

    function checkEligibility() {
      const policies = getPolicies();
      if (!policies || policies.length === 0) {
        alert("No Bank Policies Found. Please add from Admin Panel.");
        return;
      }

      const input = {
        vintage: Number(document.getElementById("vintage").value || 0),
        turnover: Number(document.getElementById("turnover").value || 0),
        requiredLoan: Number(document.getElementById("requiredLoan").value || 0),
        abb: Number(document.getElementById("abb").value || 0),
        cibil: Number(document.getElementById("cibil").value || 0),
        bankingType: document.getElementById("bankingType").value,
        ownHouse: document.getElementById("ownHouse").value,
        gst: document.getElementById("gst").value,
        itr: document.getElementById("itr").value
      };

      const tbody = document.getElementById("resultBody");
      const table = document.getElementById("resultTable");
      const summary = document.getElementById("summary");
      const downloads = document.getElementById("downloads");

      tbody.innerHTML = "";
      let eligibleCount = 0;
      let notEligibleCount = 0;

      policies.forEach(p => {
        let eligible = true;
        let maxLoan = 0;
        let reason = "Conditions not matched";

        // BASE PROGRAM
        if (p.baseProgram) {
          const bp = p.baseProgram;
          if (bp.vintage && input.vintage < bp.vintage) eligible = false;
          if (bp.turnover && input.turnover < bp.turnover) eligible = false;
          if (bp.cibil && input.cibil < bp.cibil) eligible = false;
          if (bp.abb && input.abb < bp.abb) eligible = false;
          if (bp.bankingType && bp.bankingType !== "All" &&
              bp.bankingType !== input.bankingType) eligible = false;
          if (bp.ownHouse && bp.ownHouse === "Yes" && input.ownHouse !== "Yes") eligible = false;
          if (bp.gstRequired && bp.gstRequired === "Yes" && input.gst !== "Yes") eligible = false;
          if (bp.itrRequired && bp.itrRequired === "Yes" && input.itr !== "Yes") eligible = false;

          if (eligible) {
            maxLoan = bp.maxLoan || 0;
            reason = "Eligible in Base Program";
          }
        }

        // ABB PROGRAMS
        if (!eligible && p.abbPrograms && p.abbPrograms.length > 0) {
          p.abbPrograms.forEach(pr => {
            if (input.abb >= pr.min && input.abb <= pr.max) {
              eligible = true;
              maxLoan = Math.max(maxLoan, pr.maxLoan || pr.max || 0);
              reason = "Eligible via ABB Program";
            }
          });
        }

        // ITR PROGRAMS
        if (!eligible && p.itrPrograms && p.itrPrograms.length > 0 && input.itr === "Yes") {
          p.itrPrograms.forEach(pr => {
            eligible = true;
            maxLoan = Math.max(maxLoan, pr.maxLoan || pr.max || 0);
            reason = "Eligible via ITR Program";
          });
        }

        // GST PROGRAMS
        if (!eligible && p.gstPrograms && p.gstPrograms.length > 0 && input.gst === "Yes") {
          p.gstPrograms.forEach(pr => {
            eligible = true;
            maxLoan = Math.max(maxLoan, pr.maxLoan || pr.max || 0);
            reason = "Eligible via GST Program";
          });
        }

        // Required Loan check
        if (eligible && input.requiredLoan > 0) {
          if (maxLoan < input.requiredLoan) {
            eligible = false;
            reason = `Eligible but Max Loan ${maxLoan}L < Required ${input.requiredLoan}L`;
          }
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.bankName}</td>
          <td class="${eligible ? 'eligible' : 'noteligible'}">
            ${eligible ? 'Eligible' : 'Not Eligible'}
          </td>
          <td>${eligible ? (maxLoan || '-') : '-'}</td>
          <td>${eligible ? 'All conditions matched' : reason}</td>
        `;
        tbody.appendChild(tr);
        eligible ? eligibleCount++ : notEligibleCount++;
      });

      table.style.display = "table";
      downloads.style.display = "block";
      summary.innerHTML = `‚úÖ Eligible : ${eligibleCount} &nbsp;&nbsp; ‚ùå Not Eligible : ${notEligibleCount}`;
    }

    function downloadExcel() {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(document.getElementById("resultTable"));
      XLSX.utils.book_append_sheet(wb, ws, "Eligibility");
      XLSX.writeFile(wb, "ELIGIWISE_Eligibility.xlsx");
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("ELIGIWISE -- Eligibility Report", 14, 15);
      doc.autoTable({ html: "#resultTable", startY: 20 });
      doc.save("ELIGIWISE_Eligibility.pdf");
    }
  </script>
</body>
</html>
